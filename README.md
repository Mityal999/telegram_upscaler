# Способ разворачивания системы
## В IDE:
1) Добавьте свой токен бота и параметры подключения сервера в .env файл, настройте максисальный размер изображения для подачи в апскейлер (управляет скоростью работы).
2) Создайте среду с версией python 3.10
3) pip install -r requirements.txt
4) python bot.py
5) python server.py


# ML System Design Doc 
## Дизайн ML системы - Telegram Upscaler 1.0

### 1. Цели и предпосылки 
#### 1.1. Обоснованность разработки продукта  
Создание инструмента (Telegram-бота) для апскейла фотографий досок, например, для учебных заведений, тренинговых центров или индивидуального использования. Это позволит пользователям улучшить качество визуального контента, в случае если им не удаётся наблюдать его вблизи.

Использование машинного обучения для апскейла изображений позволит автоматически улучшать качество фотографий, делая текст на них более понятными.

Успешной итерацией будет считаться достижение высокой степени удовлетворенности пользователей качеством апскейла и удобством использования бота, а также в будущем достижение определенного количества активных пользователей в месяц, что покажет актуальность проблемы и её закрытие предложенным нами методом.

Бизнес процесс выглядит следующим образом: пользователи загружают фотографии через Telegram-бота, система обрабатывает запросы и возвращает улучшенные изображения.

#### 1.2. Бизнес-требования и ограничения  
- Продукт должен обеспечивать быстрый и качественный апскейл фотографий досок с текстом или другими визуальными элементами. Пользователь отправляет обрезанную фотографию доски, и в течение минуты получает улучшенное изображение.
- Время обработки изображения не должно превышать 2 минуты.
- Работа бота должна быть стабильной при одновременном обращении нескольких пользователей.
- Успешность пилота будет определяться количеством активных пользователей, положительными отзывами о качестве апскейла и надежностью работы системы.
- Один пользователь может отправить несколько изображений подряд, и они будут обработаны параллельно.

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   
В скоуп итерации входит разработка и интеграция ML-модели для апскейла изображений, создание Telegram-бота для взаимодействия с пользователем. Расширенные функции бота, такие как автоматическое распознавание текста на изображении или интеграция с другими платформами, будут рассмотрены в последующих итерациях.
Некоторые возможные оптимизации производительности или расширения функционала могут быть отложены до следующих итераций.

#### 1.4. Предпосылки решения  
Планируется создать 2 версии MVP: с апскейлом для одного пользователя, и многопользовательским режимом - в котором для одной аудитории улучшенные изображения будут делиться между пользователями.

- Проект ведётся в GitHub
- Документация – google docs на google disc. Должна содержать описание алгоритма, результаты промежуточных тестов
- Код. В JupyterLab, соответствует PEP8, разбит на модули
- Стек: PyTorch, transformers + стандартный для DS

#### 1.5. Основной юзкейс  
Пользователь хочет прочитать некий текст, находящийсы далеко, но не видит его. 
Он фотографирует область с текстом, на своем телефоне вырезает нужную часть, и отправляет боту.
Бот направляет запрос на апскейл на сервер через REST. Апскейл изображения производится в течение 1-2 минут, в зависимости от размера изображения, ответ возвращается боту. Бот отправляет пользователю более качаственное изображение, на котором теперь возможно разобрать текст.



### 2. Методология      

#### 2.1. Постановка задачи  
Задача генерации изображения. 

#### 2.2. Блок-схема решения  
- Блок-схема для бейзлайна и основного MVP с ключевыми этапами решения задачи: подготовка данных, построение прогнозных моделей, оптимизация, тестирование, закрытие технического долга, подготовка пилота, другое.   

#### 2.3. Этапы решения задачи 
Этап 1 - Подготовка данных:
- Сбор данных: фотографии досок с различным контентом (текст, графики), видеозаписи лекций с нарезкой их на ихображения.

Этап 2 - Подготовка прогнозных моделей:
- MVP: Использование модели на основе существующих решений для апскейла изображений.

Этап 3 - Интерпретация моделей:
- Оценка случаев плохой и хорошей работы модели - когда после апскейла текст имеет смысл, и когда он дополняется несвязными символами.  

Этап 4 - Интеграция бизнес правил:
- Определение бизнес правил для финальной проверки качества улучшенных изображений перед отправкой пользователю.

Этап 5 - Подготовка инференса модели по итерациям:
- Разработка системы для эффективного запуска модели в реальном времени с минимальной задержкой.

Этап 6 - Интеграция бизнес правил:
- Дополнительная проверка на соответствие бизнес требованиям перед окончательной отправкой изображения пользователю.

Этап 7 - Разработка оптимизатора:
- Выбор оптимальной модели на основе результатов тестирования различных подходов.

Этап 8 - Подготовка финального отчета:
- Составление отчета о достигнутых результатах, проблемах, возможностях для улучшения и рекомендациях по дальнейшему развитию проекта.
  
  
### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  
  
Для оценки пилота будет использоваться комбинация количественных и качественных метрик. Количественные метрики включают время обработки изображения, процент успешно обработанных запросов, и уровень улучшения качества изображения на основе стандартных метрик, таких как PSNR (Peak Signal-to-Noise Ratio) и SSIM (Structural Similarity Index). Качественная оценка будет проведена посредством сбора обратной связи от пользователей через опросы и интервью.

В качестве бейслайна берется процент верно распознанных людьми слов и формул на исходном изображении.
Сравнение происходит с распознанием ими же апскейл изображения.

В распознавании изображений будут участвовать студенты младших курсов, по материалам старших курсов, чтобы исключить прямое запоминание текста. 
  
#### 3.2. Что считаем успешным пилотом  
  
Формализованные в пилоте метрики оценки успешности:
- Более 50% текста/формул, не распознанных людьми в исходном виде, должны быть распознаны ими в апскейл версии.
- Время обработки изображения не превышает 2 минут в 95% случаев.
- Процент успешно обработанных запросов не менее 98%.
- Улучшение качества изображения на 20% и более по сравнению с исходным, оцениваемое через PSNR и SSIM.
- 80% положительных отзывов от пользователей по результатам опросов. Опросы проводятся через бота.


### 4. Внедрение для production систем, если требуется
#### 4.1. Архитектура решения
Для обеспечения надежной работы и масштабируемости системы предлагается использовать микросервисную архитектуру, разделяя функциональность на независимые сервисы:

- Сервис обработки изображений: использует модели PyTorch для улучшения качества фотографий досок. Модель загружается из Hugging Face.
- Telegram-бот: интерфейс взаимодействия с пользователем, использует библиотеку aiogram.
- База данных: хранение информации о пользователях и их запросах.
- Все сервисы упаковываются в Docker-контейнеры для упрощения развертывания.

#### 4.2. Описание инфраструктуры и масштабируемости
Масштабируемость будет достигнута за счет использования Kubernetes для управления контейнерами. Это позволит автоматически масштабировать количество инстансов каждого сервиса в зависимости от нагрузки, обеспечивая высокую доступность и производительность системы без необходимости ручного вмешательства.

Также масштабируемость обеспечивается использованием

#### 4.3. Требования к работе системы
Производительность: система должна обрабатывать запросы пользователей без значительных задержек.
Надежность: автоматическое восстановление после сбоев, возобновление апскейла.
Мониторинг и логирование: для оперативного реагирования на инциденты и оптимизации работы системы.

#### 4.4. Безопасность системы
Требуется не допустить случайной публикации ключа бота.

#### 4.5. Безопасность данных
Дополнительные меры не требуются, т.к. Telegram достаточно безопасен для персональных данных.

#### 4.6. Издержки
Точные издержки можно будет оценить после нагрузочного тестирования, но ожидается, что основные затраты будут связаны с использованием облачных вычислений, т.к. требуется использование мощных GPU.

#### 4.7. Integration points
Интеграция между компонентами системы через REST API позволит легко добавлять новые сервисы и функциональности, а также интегрироваться с внешними системами в будущем.

#### 4.8. Требования к аппаратным мощностям
- CPU: Рекомендуется использовать многоядерный процессор с высокой тактовой частотой.
- RAM: Минимум 8 ГБ оперативной памяти, чтобы обеспечить достаточное пространство для загрузки модели и обработки изображений.
- Disk: Для хранения модели и временных файлов желательно иметь SSD с минимум 10 ГБ свободного пространства.
- GPU: Видеокарта с минимум 6 ГБ видеопамяти (для оставления пространства на системные процессы) и поддержкой CUDA будет необходима.
- Сеть: Гигабитный интернет для обеспечения быстрой загрузки и скачивания изображений.

В случае высокой нагрузки:
CPU: Рекомендуется использовать серверные процессоры с большим количеством ядер и потоков, такие как Xeon или AMD EPYC.
RAM: При высокой нагрузке необходимо увеличить объём оперативной памяти, возможно до 32 ГБ или более, чтобы обрабатывать большое количество запросов одновременно.
Disk: Рекомендуется RAID-массив из SSD для повышения производительности и отказоустойчивости.
GPU: Возможно потребуется несколько GPU для масштабирования обработки запросов или использование более мощных карт, таких как NVIDIA Tesla или A100.
Сеть: Многопортовый гигабитный интернет или даже 10-гигабитный для обеспечения необходимой пропускной способности.